package boardgame.chess

import boardgame.chess.core.{CastlingMovement, ChessGame}
import org.scalatest.{ShouldMatchers, FunSpec}

class CastlingTest extends FunSpec with ShouldMatchers {
  describe("Castling") {
    it("should determine that white king can castle") {
      val game = ChessGame.fromString(
        """....♚..♜
          |........
          |........
          |........
          |........
          |........
          |........
          |........""".stripMargin)
      implicit val rules = game.rules
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe true
    }
    it("should determine that white king can't castle because it's not in initial position") {
      val game = ChessGame.fromString(
        """...♚...♜
          |........
          |........
          |........
          |........
          |........
          |........
          |........""".stripMargin)
      implicit val rules = game.rules
      val board = game.board

      game.whitePlayer.movements(board).forall {
        case m: CastlingMovement => false
        case _ => true
      } shouldBe true
    }
    it("should determine that white king can't castle because target rook is not in initial position") {
      val game = ChessGame.fromString(
        """....♚.♜.
          |........
          |........
          |........
          |........
          |........
          |........
          |........""".stripMargin)
      implicit val rules = game.rules
      val board = game.board

      game.whitePlayer.movements(board).forall {
        case m: CastlingMovement => false
        case _ => true
      } shouldBe true
    }
    it("should determine that white king can't castle because white is on top unless otherwise specified") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |........
          |....♚..♜""".stripMargin)
      implicit val rules = game.rules
      val board = game.board

      game.whitePlayer.movements(board).forall {
        case m: CastlingMovement => false
        case _ => true
      } shouldBe true
    }
    it("should determine that white king can castle because white is specified to be on the bottom") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |........
          |....♚..♜""".stripMargin)
      implicit val rules = game.rules.copy(whitePawnDirection = -1)
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe true
    }
    it("should determine that white king can't castle because the king is threatened") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |....♖...
          |....♚..♜""".stripMargin)
      implicit val rules = game.rules.copy(whitePawnDirection = -1)
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe false
    }
    it("should determine that white king can't castle because a piece the king will pass through is threatened") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |.....♖..
          |....♚..♜""".stripMargin)
      implicit val rules = game.rules.copy(whitePawnDirection = -1)
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe false
    }
    it("should determine that white king can't long castle because a piece the king will pass through is threatened") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |..♖.....
          |♜...♚...""".stripMargin)
      implicit val rules = game.rules.copy(whitePawnDirection = -1)
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe false
    }
    it("should determine that white king can long castle") {
      val game = ChessGame.fromString(
        """........
          |........
          |........
          |........
          |........
          |........
          |.....♖..
          |♜...♚...""".stripMargin)
      implicit val rules = game.rules.copy(whitePawnDirection = -1)
      val board = game.board

      game.whitePlayer.movements(board).exists {
        case m: CastlingMovement => true
        case _ => false
      } shouldBe true
    }
  }
}
